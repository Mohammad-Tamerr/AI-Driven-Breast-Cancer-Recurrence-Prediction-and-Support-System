<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙÙŠÙ‚ - Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Add marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <h1>ğŸ’– Ø±ÙÙŠÙ‚ - Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚</h1>
            <p>Ù…Ø¹Ø§Ùƒ ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ© Ù…Ù† Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬</p>
        </div>

        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message">
                <div class="emoji">ğŸŒ¸</div>
                <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
                <p>
                    Ø£Ù†Ø§ Ø±ÙÙŠÙ‚ØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ®ØµØµ ÙÙŠ Ø³Ø±Ø·Ø§Ù† Ø§Ù„Ø«Ø¯ÙŠ.<br>
                    Ù‡Ù†Ø§ Ù„Ø£Ù‚Ø¯Ù… Ù„Ùƒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ.<br>
                    Ø§Ø³Ø£Ù„ÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ÙˆØ£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©! ğŸ’ª
                </p>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <input 
                type="text" 
                id="userInput" 
                placeholder="Ø§ÙƒØªØ¨ÙŠ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... ğŸ’¬"
                autocomplete="off"
            >
            <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messagesContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');

        // Configure marked.js options
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Auto-scroll to bottom
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Format text with markdown-like syntax
        function formatMessage(text) {
            // Convert markdown to HTML
            let formatted = marked.parse(text);
            
            // Additional custom formatting
            formatted = formatted
                // Make bold text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                // Make italic text
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // Add emoji spacing
                .replace(/([\u{1F300}-\u{1F9FF}])/gu, '<span class="emoji-inline">$1</span>');
            
            return formatted;
        }

        // Auto-scroll to bottom
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add message to chat
        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            avatarDiv.textContent = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Format message if it's from bot
            if (!isUser) {
                contentDiv.innerHTML = formatMessage(text);
            } else {
                contentDiv.textContent = text;
            }
            
            if (isUser) {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
            } else {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatarDiv);
            }
            
            // Remove welcome message on first user message
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg && isUser) {
                welcomeMsg.remove();
            }
            
            // Insert before typing indicator
            messagesContainer.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        // Show/Hide typing indicator
        function showTyping(show) {
            typingIndicator.classList.toggle('show', show);
            scrollToBottom();
        }

        // Send message
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, true);
            userInput.value = '';
            sendBtn.disabled = true;
            
            // Show typing indicator
            showTyping(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: message })
                });

                const data = await response.json();
                
                // Hide typing indicator
                showTyping(false);
                
                // Add bot response
                if (data.answer) {
                    addMessage(data.answer, false);
                } else if (data.error) {
                    addMessage('âš ï¸ ' + data.error, false);
                } else {
                    addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
                }
            } catch (error) {
                showTyping(false);
                addMessage('âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', false);
                console.error('Error:', error);
            }

            sendBtn.disabled = false;
            userInput.focus();
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on load
        userInput.focus();
    </script>
</body>
</html>